#!/bin/bash
#
# This script is triggered when an interface goes down.
# It reverts the node from a gateway back to a normal mesh client.
#

TARGET_IFACE="end0" # Define the Ethernet interface name here
GATEWAY_STATE_FILE="/var/run/mesh-gateway.state"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] - GATEWAY-DOWN: $1" | systemd-cat -t mesh-gateway
}

# Compare the actual interface ($IFACE) with our target ($TARGET_IFACE)
if [ "$IFACE" != "$TARGET_IFACE" ]; then
    exit 0
fi

log "Internet connection lost on $IFACE. Reverting to mesh client mode..."
rm -f "$GATEWAY_STATE_FILE"

# --- 1. Revert NTP Role ---
# Check if chrony is actually running in server mode before reverting.
# This prevents unnecessary stops/starts if the external sync failed initially.
if systemctl is-active --quiet chrony.service && grep -q "allow fd5a" /etc/chrony/chrony.conf; then
    log "We were an NTP server. Reverting chrony."
    systemctl stop chrony.service
	cp /etc/chrony-default.conf /etc/chrony.conf
fi
# Ensure chrony is stopped regardless, as it shouldn't run as a client constantly
systemctl stop chrony.service


# --- 2. Revert Gateway Role ---
batctl gw_mode client
cp /etc/radvd-mesh.conf /etc/radvd.conf
systemctl restart radvd

# --- 3. Announce Changes to Mesh ---
log "Triggering mesh-node-manager to publish new non-gateway status..."
systemctl restart mesh-node-manager.service

log "Reversion to client mode complete."

