#!/bin/bash
#
# This script is triggered when an interface becomes "routable".
# It promotes the node to a B.A.T.M.A.N. gateway and, if it can
# successfully sync its own time, it also becomes an NTP server.
#

IFACE="$1"
GATEWAY_STATE_FILE="/var/run/mesh-gateway.state"
ETH_IF="end0"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] - GATEWAY-UP: $1" | systemd-cat -t mesh-gateway
}

# --- Initial Checks ---
# Make sure the ethernet port is what's triggering the state
if [ "$IFACE" != "$ETH_IF" ] || [ -f "$GATEWAY_STATE_FILE" ]; then
    exit 0
fi
if ! ping -c 3 -I "$IFACE" 8.8.8.8 > /dev/null 2>&1; then
    log "Interface $IFACE is routable but has no internet access. Not promoting."
    exit 0
fi

log "Internet detected on $IFACE. Promoting to mesh gateway..."
touch "$GATEWAY_STATE_FILE"

# --- 1. Attempt to Become an NTP Server ---
log "Attempting to sync time with external NTP source..."
systemctl stop chrony.service
cp /etc/chrony/chrony-test.conf /etc/chrony/chrony.conf
systemctl start chrony.service

# The 'chronyc' command will exit with a non-zero status if it fails to sync.
if chronyc -a 'burst 4/4'; then
    log "Time sync successful. Promoting to mesh NTP server."
    # Stop the client service, activate the server config, and start it.
    systemctl stop chrony.service
    cp /etc/chrony/chrony-server.conf /etc/chrony/chrony.conf
    systemctl start chrony.service
else
    log "Failed to sync time with external NTP source. Will not become an NTP server."
    systemctl stop chrony.service
    cp /etc/chrony/chrony-client.conf /etc/chrony/chrony.conf
    systemctl start chrony.service

    # We will continue as a data gateway, but not a time source.
fi

# --- 2. Become an IPv6 Data Gateway ---
log "Enabling IPv6 gateway mode..."
cp /etc/radvd-gateway.conf /etc/radvd.conf
systemctl restart radvd
batctl gw_mode server

# --- 3. Announce Changes to Mesh ---
# Trigger the manager to immediately publish the new gateway status.
# The manager script will correctly report whether this node is an NTP server or not.
log "Triggering mesh-node-manager to publish new status..."
systemctl restart mesh-node-manager.service

log "Promotion to gateway complete."

