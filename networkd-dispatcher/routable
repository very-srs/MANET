#!/bin/bash
TARGET_IFACE="end0"
GATEWAY_STATE_FILE="/var/run/mesh-gateway.state"
NTP_STATE_FILE="/var/run/mesh-ntp.state"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] - GATEWAY-UP [$$]($IFACE): $1" | systemd-cat -t mesh-gateway
}

if [ "$IFACE" != "$TARGET_IFACE" ]; then
    exit 0
fi

if [ -f "$GATEWAY_STATE_FILE" ]; then
    log "Exiting: Gateway state file already exists."
    exit 0
fi

if ! ping -c 3 -W 2 -I "$IFACE" 8.8.8.8 > /dev/null 2>&1; then
    log "Exiting: Internet ping check failed via $IFACE."
    exit 0
fi

log "Internet detected on $IFACE. Promoting to mesh gateway..."
touch "$GATEWAY_STATE_FILE"

# --- NTP Server Setup ---
log "Attempting to sync time with external NTP source..."
cp /etc/chrony/chrony-test.conf /etc/chrony/chrony.conf
systemctl restart chrony.service
sleep 3

if timeout 30 chronyc -a 'burst 4/4' && sleep 5 && chronyc sources | grep -q '^\*'; then
    log "Time sync successful. Promoting to mesh NTP server."
    touch "$NTP_STATE_FILE"
    systemctl stop chrony.service
    cp /etc/chrony/chrony-server.conf /etc/chrony/chrony.conf
    systemctl start chrony.service
else
    log "Failed to sync time. Will not become an NTP server."
    rm -f "$NTP_STATE_FILE"
    systemctl stop chrony.service
    cp /etc/chrony/chrony-default.conf /etc/chrony/chrony.conf
fi

# --- Gateway Mode ---
log "Enabling IPv6 gateway mode..."
batctl gw_mode server

# Wait and verify
sleep 2
if ! batctl gw_mode | grep -q "server"; then
    log "ERROR: Failed to set gateway mode to server!"
fi

cp /etc/radvd-gateway.conf /etc/radvd.conf
systemctl restart radvd

# --- Announce to Mesh ---
log "Triggering node-manager to publish new status..."
systemctl restart node-manager.service

log "Promotion to gateway complete."
