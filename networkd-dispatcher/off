#!/bin/bash
TARGET_IFACE="end0"
GATEWAY_STATE_FILE="/var/run/mesh-gateway.state"
NTP_STATE_FILE="/var/run/mesh-ntp.state"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] - GATEWAY-DOWN: $1" | systemd-cat -t mesh-gateway
}

if [ "$IFACE" != "$TARGET_IFACE" ]; then
    exit 0
fi

# Check if we were actually a gateway
if [ ! -f "$GATEWAY_STATE_FILE" ]; then
    log "Not currently a gateway. Nothing to do."
    exit 0
fi

log "Internet connection lost on $IFACE. Reverting to mesh client mode..."

# Remove state files FIRST
rm -f "$GATEWAY_STATE_FILE"
rm -f "$NTP_STATE_FILE"

# Stop NTP server if running
if systemctl is-active --quiet chrony.service; then
    log "Stopping chrony service."
    systemctl stop chrony.service
    cp /etc/chrony/chrony-default.conf /etc/chrony/chrony.conf
fi

# Revert batman-adv mode
batctl gw_mode client

# Wait and verify
sleep 2
if ! batctl gw_mode | grep -q "client"; then
    log "ERROR: Failed to revert gateway mode to client!"
fi

# Revert radvd
cp /etc/radvd-mesh.conf /etc/radvd.conf
systemctl restart radvd

# Announce changes
log "Triggering node-manager to publish new non-gateway status..."
systemctl restart node-manager.service

log "Reversion to client mode complete."
